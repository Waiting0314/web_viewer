{% extends 'base.html' %}

{% block content %}
<div style="max-width: 600px; margin: 0 auto;">
    <h1 style="margin-bottom: 2rem;">上傳新相簿</h1>

    <div class="card">
        <div class="card-body">
            <!-- Tabs -->
            <div style="display: flex; border-bottom: 1px solid #334155; margin-bottom: 1.5rem;">
                <button type="button" onclick="switchTab('zip')" id="tab-zip"
                    style="background: none; border: none; padding: 0.75rem 1.5rem; color: #3b82f6; border-bottom: 2px solid #3b82f6; cursor: pointer; font-weight: 600;">
                    Zip 上傳
                </button>
                <button type="button" onclick="switchTab('folder')" id="tab-folder"
                    style="background: none; border: none; padding: 0.75rem 1.5rem; color: #94a3b8; border-bottom: 2px solid transparent; cursor: pointer; font-weight: 600;">
                    資料夾上傳
                </button>
            </div>

            <form method="post" enctype="multipart/form-data" id="upload-form">
                {% csrf_token %}

                <!-- Common Fields -->
                {% for field in form %}
                {% if field.name != 'zip_file' %}
                <div class="form-group">
                    <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                    {{ field }}
                    {% if field.help_text %}
                    <small style="color: #64748b; display: block; margin-top: 0.25rem;">{{ field.help_text }}</small>
                    {% endif %}
                    {% if field.errors %}
                    <div style="color: #ef4444; font-size: 0.875rem; margin-top: 0.25rem;">
                        {{ field.errors }}
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                {% endfor %}

                <!-- Zip Upload Field -->
                <div id="zip-field" class="form-group">
                    <label for="{{ form.zip_file.id_for_label }}">{{ form.zip_file.label }}</label>
                    {{ form.zip_file }}
                    {% if form.zip_file.help_text %}
                    <small style="color: #64748b; display: block; margin-top: 0.25rem;">{{ form.zip_file.help_text
                        }}</small>
                    {% endif %}
                    {% if form.zip_file.errors %}
                    <div style="color: #ef4444; font-size: 0.875rem; margin-top: 0.25rem;">
                        {{ form.zip_file.errors }}
                    </div>
                    {% endif %}
                </div>

                <!-- Folder Upload Field -->
                <div id="folder-field" class="form-group" style="display: none;">
                    <label for="folder_files">選擇資料夾</label>
                    <input type="file" name="folder_files" id="folder_files" webkitdirectory directory multiple
                        style="width: 100%; padding: 0.5rem; background: #0f172a; border: 1px solid #334155; border-radius: 0.375rem; color: #e2e8f0;">
                    <small style="color: #64748b; display: block; margin-top: 0.25rem;">請選擇包含照片的資料夾</small>
                </div>

                <div style="margin-top: 2rem;">
                    <button type="submit">建立相簿</button>
                    <a href="{% url 'album_list' %}"
                        style="margin-left: 1rem; color: #64748b; text-decoration: none;">取消</a>
                </div>
            </form>

            <!-- Progress Bar -->
            <div id="upload-progress" style="display: none; margin-top: 1.5rem;">
                <div style="font-weight: 600; margin-bottom: 0.5rem;">上傳進度:</div>
                <div style="width: 100%; background-color: #e2e8f0; border-radius: 0.375rem; overflow: hidden;">
                    <div id="progress-bar"
                        style="width: 0%; height: 1.5rem; background-color: #3b82f6; text-align: center; line-height: 1.5rem; color: white; font-weight: 600;">
                        <span id="progress-text">0%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function switchTab(mode) {
        const zipTab = document.getElementById('tab-zip');
        const folderTab = document.getElementById('tab-folder');
        const zipField = document.getElementById('zip-field');
        const folderField = document.getElementById('folder-field');
        const zipInput = document.getElementById('{{ form.zip_file.id_for_label }}');
        const folderInput = document.getElementById('folder_files');

        if (mode === 'zip') {
            zipTab.style.color = '#3b82f6';
            zipTab.style.borderBottomColor = '#3b82f6';
            folderTab.style.color = '#94a3b8';
            folderTab.style.borderBottomColor = 'transparent';

            zipField.style.display = 'block';
            folderField.style.display = 'none';

            // Clear folder input
            folderInput.value = '';
        } else {
            folderTab.style.color = '#3b82f6';
            folderTab.style.borderBottomColor = '#3b82f6';
            zipTab.style.color = '#94a3b8';
            zipTab.style.borderBottomColor = 'transparent';

            zipField.style.display = 'none';
            folderField.style.display = 'block';

            // Clear zip input
            if (zipInput) zipInput.value = '';
        }
    }

    // AJAX Upload Logic
    document.getElementById('upload-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const form = this;
        const formData = new FormData(form);
        const xhr = new XMLHttpRequest();
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const progressContainer = document.getElementById('upload-progress');
        const submitBtn = form.querySelector('button[type="submit"]');
        
        // Show progress
        progressContainer.style.display = 'block';
        submitBtn.disabled = true;
        submitBtn.textContent = '上傳中...';
        
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percent = Math.round((e.loaded / e.total) * 100);
                progressBar.style.width = percent + '%';
                progressText.textContent = percent + '%';
            }
        });
        
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response.status === 'success') {
                            window.location.href = response.redirect_url + '?from_upload=true';
                        } else {
                            throw new Error(response.message || 'Unknown error');
                        }
                    } catch (e) {
                        alert('上傳成功，但解析回應時發生錯誤。將重新導向...');
                        window.location.reload();
                    }
                } else {
                    let errorMessage = '上傳失敗';
                    try {
                        const response = JSON.parse(xhr.responseText);
                        errorMessage += ': ' + (response.message || response.errors || '未知錯誤');
                    } catch (e) {
                        errorMessage += ': 伺服器錯誤 (' + xhr.status + ')';
                    }
                    alert(errorMessage);
                    submitBtn.disabled = false;
                    submitBtn.textContent = '建立相簿';
                    progressContainer.style.display = 'none';
                    progressBar.style.width = '0%';
                    progressText.textContent = '0%';
                }
            }
        };
        
        xhr.open('POST', form.action || window.location.href, true);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.send(formData);
    });
</script>
{% endblock %}